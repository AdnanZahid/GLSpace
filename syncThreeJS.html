<!DOCTYPE html>
<html>
<script type="text/javascript">
  var video;
</script>
<head>

  <title>Sync Three.js</title>
  <link rel="stylesheet" href="syncThreeJS.css">
        
  <link rel="chrome-webstore-item" href="https://chrome.google.com/webstore/detail/ajhifddimkapgcifgcodmmfdlknahffk">
  
  <script src='https://www.webrtc-experiment.com/firebase.js'> </script>
  <script src="https://www.webrtc-experiment.com/Pluginfree-Screen-Sharing/conference.js"> </script>

  <iframe style="width: 1024px; height: 1024px; display: none;" id="i1" src="ny.jpg"></iframe>
  <iframe style="width: 1024px; height: 1024px; display: none;" id="i2" src="ny.jpg"></iframe>
  <iframe style="width: 1024px; height: 1024px; display: none;" id="i3" src="ny.jpg"></iframe>

  <script data-main="syncThreeJS.js" src="jquery.js"></script>
  <script data-main="syncThreeJS.js" src="three.js"></script>
  <script data-main="syncThreeJS.js" src="require.js"></script>

</head>
<body onkeypress="handleIt(event);">

<style>
  textarea {resize: none; float: left;}
  table {display: none;}
  #ThreeJS {position: absolute; left:0px; top:50px;}
  p {color: red; font-weight:900;}
  .experiment {position: fixed; z-index: 2; left:0px; top:0px;}
</style>

<section class="experiment">                
  <section>
      <span style="display: none;">
          Private ?? <a href="/Pluginfree-Screen-Sharing/" target="_blank" title="Open this link for private screen sharing!"><code><strong id="unique-token">#123456789</strong></code></a>
      </span>
      <input type="text" id="room-name" placeholder="Your Name" disabled style="display: none;">
      <button style="margin-left: 200px;" id="share-screen" class="setup" disabled>Load</button>
  </section>

  <script>
    var isWebRTCExperimentsDomain = document.domain.indexOf('webrtc-experiment.com') != -1;

    var config = {
        openSocket: function(config) {
            var channel = config.channel || 'screen-capturing-' + location.href.replace( /\/|:|#|%|\.|\[|\]/g , '');
            var socket = new Firebase('https://chat.firebaseIO.com/' + channel);
            socket.channel = channel;
            socket.on("child_added", function(data) {
                config.onmessage && config.onmessage(data.val());
            });
            socket.send = function(data) {
                this.push(data);
            };
            config.onopen && setTimeout(config.onopen, 1);
            socket.onDisconnect().remove();
            return socket;
        },
        onRemoteStream: function(media) {
            var video = media.video;
            video.setAttribute('controls', true);
            videosContainer.insertBefore(video, videosContainer.firstChild);
            video.play();
            rotateVideo(video);
        },
        onRoomFound: function(room) {
            var alreadyExist = document.getElementById(room.broadcaster);
            if (alreadyExist) return;

            if (typeof roomsList === 'undefined') roomsList = document.body;

            var tr = document.createElement('tr');
            tr.setAttribute('id', room.broadcaster);
            tr.innerHTML = '<td>' + room.roomName + '</td>' +
                '<td><button class="join" id="' + room.roomToken + '">Open Screen</button></td>';
            roomsList.insertBefore(tr, roomsList.firstChild);

            var button = tr.querySelector('.join');
            button.onclick = function() {
                var button = this;
                button.disabled = true;
                conferenceUI.joinRoom({
                    roomToken: button.id,
                    joinUser: button.parentNode.parentNode.id
                });
            };
        },
        onNewParticipant: function(numberOfParticipants) {
            document.title = numberOfParticipants + ' users are viewing your screen!';
            var element = document.getElementById('number-of-participants');
            if (element) {
                element.innerHTML = numberOfParticipants + ' users are viewing your screen!';
            }
        }
    };

    function captureUserMedia(callback, extensionAvailable) {
        console.log('captureUserMedia chromeMediaSource', DetectRTC.screen.chromeMediaSource);
        
        var screen_constraints = {
            mandatory: {
                chromeMediaSource: DetectRTC.screen.chromeMediaSource,
                maxWidth: 1920,
                maxHeight: 1080,
                minAspectRatio: 1.77
            },
            optional: []
        };

        if(isWebRTCExperimentsDomain && typeof extensionAvailable == 'undefined' && DetectRTC.screen.chromeMediaSource != 'desktop') {
            DetectRTC.screen.isChromeExtensionAvailable(function(available) {
                captureUserMedia(callback, available);
            });
            return;
        }
        
        if(isWebRTCExperimentsDomain && DetectRTC.screen.chromeMediaSource == 'desktop' && !DetectRTC.screen.sourceId) {
            DetectRTC.screen.getSourceId(function(error) {
                if(error && error == 'PermissionDeniedError') {
                    alert('PermissionDeniedError: User denied to share content of his screen.');
                }
                
                captureUserMedia(callback);
            });
            return;
        }
        
        if(!isWebRTCExperimentsDomain && !DetectRTC.screen.sourceId) {
            window.addEventListener('message', function (event) {
                if (event.data && event.data.chromeMediaSourceId) {
                    var sourceId = event.data.chromeMediaSourceId;

                    DetectRTC.screen.sourceId = sourceId;
                    DetectRTC.screen.chromeMediaSource = 'desktop';

                    if (sourceId == 'PermissionDeniedError') {
                        return alert('User denied to share content of his screen.');
                    }

                    captureUserMedia(callback, true);
                }

                if (event.data && event.data.chromeExtensionStatus) {
                    // warn('Screen capturing extension status is:', event.data.chromeExtensionStatus);
                    DetectRTC.screen.chromeMediaSource = 'screen';
                    captureUserMedia(callback, true);
                }
            });
            screenFrame.postMessage();
            return;
        }
        
        if(DetectRTC.screen.chromeMediaSource == 'desktop') {
            screen_constraints.mandatory.chromeMediaSourceId = DetectRTC.screen.sourceId;
        }
        
        var constraints = {
            audio: false,
            video: screen_constraints
        };
        
        console.log( JSON.stringify( constraints , null, '\t') );
        
        video = document.createElement('video');
        video.setAttribute('autoplay', true);
        video.setAttribute('controls', true);
        videosContainer.insertBefore(video, videosContainer.firstChild);
        
        getUserMedia({
            video: video,
            constraints: constraints,
            onsuccess: function(stream) {
                config.attachStream = stream;
                callback && callback();

                video.setAttribute('muted', true);
                rotateVideo(video);
            },
            onerror: function() {
                if (location.protocol === 'http:') {
                    alert('Please test this WebRTC experiment on HTTPS.');
                } else {
                    alert('Screen capturing is either denied or not supported. Please install chrome extension for screen capturing or run chrome with command-line flag: --enable-usermedia-screen-capturing');
                }
            }
        });

        videoImage = document.createElement( 'canvas' );
        videoImage.width = 1024;
        videoImage.height = 700;

        videoImageContext = videoImage.getContext( '2d' );
        // background color if no video present
        videoImageContext.fillStyle = '#000000';
        videoImageContext.fillRect( 0, 0, videoImage.width, videoImage.height );

        videoTexture = new THREE.Texture( videoImage );
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;
        
        var movieMaterial = new THREE.MeshBasicMaterial( { map: videoTexture, overdraw: true, side:THREE.DoubleSide } );
        // the geometry on which the movie will be displayed;
        //    movie image will be scaled to fit these dimensions.
        var movieGeometry = new THREE.PlaneGeometry( 240, 100, 4, 4 );
        var movieScreen = new THREE.Mesh( movieGeometry, movieMaterial );
        movieScreen.position.set(0,700,600);
        scene.add(movieScreen);
        
        camera.lookAt(movieScreen.position);
    }

    var conferenceUI = conference(config);

    var videosContainer = document.getElementById("videos-container") || document.body;
    var roomsList = document.getElementById('rooms-list');

    document.getElementById('share-screen').onclick = function() {
        var roomName = document.getElementById('room-name') || { };
        roomName.disabled = true;
        captureUserMedia(function() {
            conferenceUI.createRoom({
                roomName: (roomName.value || 'Anonymous') + ' shared his screen with you'
            });
        });
        this.disabled = true;
    };

    function rotateVideo(video) {
        video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(0deg)';
        setTimeout(function() {
            video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(360deg)';
        }, 1000);
    }

    (function() {
        var uniqueToken = document.getElementById('unique-token');
        if (uniqueToken)
            if (location.hash.length > 2) uniqueToken.parentNode.parentNode.parentNode.innerHTML = '<h2 style="text-align:center;"><a href="' + location.href + '" target="_blank">Share this link</a></h2>';
            else uniqueToken.innerHTML = uniqueToken.parentNode.parentNode.href = '#' + (Math.random() * new Date().getTime()).toString(36).toUpperCase().replace( /\./g , '-');
    })();

</script>

<script>
    var screenFrame, loadedScreenFrame;
    
    function loadScreenFrame(skip) {
        if(loadedScreenFrame) return;
        if(!skip) return loadScreenFrame(true);

        loadedScreenFrame = true;

        var iframe = document.createElement('iframe');
        iframe.onload = function () {
            iframe.isLoaded = true;
            console.log('Screen Capturing frame is loaded.');
            
            document.getElementById('share-screen').disabled = false;
            document.getElementById('room-name').disabled = false;
        };
        iframe.src = 'https://www.webrtc-experiment.com/getSourceId/';
        iframe.style.display = 'none';
        (document.body || document.documentElement).appendChild(iframe);

        screenFrame = {
            postMessage: function () {
                if (!iframe.isLoaded) {
                    setTimeout(screenFrame.postMessage, 100);
                    return;
                }
                console.log('Asking iframe for sourceId.');
                iframe.contentWindow.postMessage({
                    captureSourceId: true
                }, '*');
            }
        };
    };
    
    if(!isWebRTCExperimentsDomain) {
        loadScreenFrame();
    }
    else {
        document.getElementById('share-screen').disabled = false;
        document.getElementById('room-name').disabled = false;
    }
</script>

<script>
    var isChrome = !!navigator.webkitGetUserMedia;
    
    var DetectRTC = {};

    (function () {
        
        var screenCallback;
        
        DetectRTC.screen = {
            chromeMediaSource: 'screen',
            getSourceId: function(callback) {
                if(!callback) throw '"callback" parameter is mandatory.';
                screenCallback = callback;
                window.postMessage('get-sourceId', '*');
            },
            isChromeExtensionAvailable: function(callback) {
                if(!callback) return;
                
                if(DetectRTC.screen.chromeMediaSource == 'desktop') return callback(true);
                
                window.postMessage('are-you-there', '*');
                
                setTimeout(function() {
                    if(DetectRTC.screen.chromeMediaSource == 'screen') {
                        callback(false);
                    }
                    else callback(true);
                }, 2000);
            },
            onMessageCallback: function(data) {
                if (!(typeof data == 'string' || !!data.sourceId)) return;
                
                console.log('chrome message', data);
                
                if(data == 'PermissionDeniedError') {
                    DetectRTC.screen.chromeMediaSource = 'PermissionDeniedError';
                    if(screenCallback) return screenCallback('PermissionDeniedError');
                    else throw new Error('PermissionDeniedError');
                }
                
                if(data == 'rtcmulticonnection-extension-loaded') {
                    if(document.getElementById('install-button')) {
                        document.getElementById('install-button').parentNode.innerHTML = '<strong>Great!</strong> <a href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk" target="_blank">Google chrome extension</a> is installed.';
                    }
                    DetectRTC.screen.chromeMediaSource = 'desktop';
                }
                
                if(data.sourceId) {
                    DetectRTC.screen.sourceId = data.sourceId;
                    if(screenCallback) screenCallback( DetectRTC.screen.sourceId );
                }
            },
            getChromeExtensionStatus: function (callback) {
                if (!!navigator.mozGetUserMedia) return callback('not-chrome');
                
                var extensionid = 'ajhifddimkapgcifgcodmmfdlknahffk';

                var image = document.createElement('img');
                image.src = 'chrome-extension://' + extensionid + '/icon.png';
                image.onload = function () {
                    DetectRTC.screen.chromeMediaSource = 'screen';
                    window.postMessage('are-you-there', '*');
                    setTimeout(function () {
                        if (!DetectRTC.screen.notInstalled) {
                            callback('installed-enabled');
                        }
                    }, 2000);
                };
                image.onerror = function () {
                    DetectRTC.screen.notInstalled = true;
                    callback('not-installed');
                };
            }
        };
        
        if(window.postMessage && isChrome) {
            DetectRTC.screen.isChromeExtensionAvailable();
        }
    })();
    
    DetectRTC.screen.getChromeExtensionStatus(function(status) {
        if(status == 'installed-enabled') {
            if(document.getElementById('install-button')) {
                document.getElementById('install-button').parentNode.innerHTML = '<strong>Great!</strong> <a href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk" target="_blank">Google chrome extension</a> is installed.';
            }
            DetectRTC.screen.chromeMediaSource = 'desktop';
        }
    });
    
    window.addEventListener('message', function (event) {
        if (event.origin != window.location.origin) {
            return;
        }
        
        DetectRTC.screen.onMessageCallback(event.data);
    });
    
    console.log('current chromeMediaSource', DetectRTC.screen.chromeMediaSource);
</script>

  <table style="width: 100%;" id="rooms-list"></table>

  <div id="videos-container"></div>
</section>

<table id="controls">
<tr>
<td><p>Left:</p></td>
<td>
  <textarea onfocus="this.select();" id="left" rows="1" cols="40"></textarea>
</td>
</tr>

<tr>
<td><p>Center:</p></td>
<td>
  <textarea onfocus="this.select();" id="center" rows="1" cols="40"></textarea>
</td>
</tr>

<tr>
<td><p>Right:</p></td>
<td>
  <textarea onfocus="this.select();" id="right" rows="1" cols="40"></textarea>
</td>
</tr>

<tr>
<td>
  <textarea style="display: none;" onfocus="this.select();" id="back" rows="1" cols="40">adnan-zahid.eu5.org</textarea>
</td>
</tr>
</table>
  
  <canvas id="c"></canvas>
  <div id="ThreeJS"></div>

</body>
</html>